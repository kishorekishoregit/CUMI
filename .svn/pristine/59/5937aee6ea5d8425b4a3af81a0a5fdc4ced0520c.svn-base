jQuery(function ($) {

    $("#txtbarcode").change(function () {
        // $("#txtSelectAllScreens").prop('checked', false);
        $.ajax({
            url: 'FetchscanBarcode',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: $.param({ 'Barcode': $('#txtbarcode').val().trim() }),
            success: function (data) {
                var Res = data.split('|');
                if (Res[0] == 'true') {
                    BindTab(JSON.parse(Res[1]), '1');
                }
                //var resJ = JSON.parse(Res);

                
               // BindTab(resJ);

            }
        });
    });
    function BindTab(ResData, type) {

        var currentDate = new Date()
        var day = currentDate.getDate()
        var month = currentDate.getMonth() + 1
        var year = currentDate.getFullYear()
        var currentdate = day + "/" + month + "/" + year;

        var cols = [];
        var cols1 = [];
        var cols1DATA = [];
        var nullvalue;
        var colsresult;
        var finalcolsresult;
        var elements = Array();
        var exampleRecord = ResData[0];
        // TABLE BIND     
        if (type == '0') {
            $('#dynamic-table').dataTable().fnDestroy();
            $('#dynamic-table').DataTable().destroy(); $('#dynamic-table').html('');
            cols.length = 0;
            cols1.length = 0;
        }
        if (exampleRecord) {
            //get keys in object. This will only work if your statement remains true that all objects have identical keys
            var keys = Object.keys(exampleRecord);

            //for each key, add a column definition
            keys.forEach(function (k) {
                cols.push({
                    title: k,
                    data: k,
                    targets: k
                    //optionally do some type detection here for render function
                });
            });

            $.each(cols, function (index, item) {

                item.title, item.targets

                cols1.push({
                    title: item.title,
                    targets: index

                });

                cols1DATA.push({
                    data: item.title,
                });
                finalcolsresult += 'null' + ',';

            });

            var dyTable = $('#dynamic-table');

            $('#dynamic-table').dataTable({
                data: ResData,
                "bAutoWidth": false,
                "info": false,
                "ascrollX": "100%",
                "paging": false,
                "destroy": true,
                "bSort": false,
                "language": { "search": "" },
                "aColumns": [
                    finalcolsresult,
                    { "bSortable": false }
                ],
                "aSorting": [],
                'columnDefs': [{
                    'targets': 0,
                    'searchable': false,
                    'orderable': false,
                    'className': 'dt-body-center'
                }],

                columnDefs: cols1,
                columns: cols1DATA,
                columns: [

                   // { 'data': 'Select' },

                    //{
                    //    'data': 'Barcode',
                    //    'render': function (data, type, full, meta) {

                    //        var pakarr = data.split('_');

                    //        return '<div>' + pakarr[1] + '<span style="visibility: hidden;">' + '_' + +pakarr[0] + '</span></div>';

                    //    }
                   // },
                    { 'data': 'ITEMCODE' },
                    { 'data': 'ITEMNAME' },
                    { 'data': 'BARCODE' },
            
          

                ],
              
       
            });
            $("#txtbarcode").val("");

        }
        else {
            $('#dynamic-table tbody').remove();
            $('#dynamic-table thead').remove();
            $('#dynamic-table').dataTable({
                "language": {
                    "emptyTable": "TemproryIn No records found.."
                },
                'bSort': false,
                'aoColumns': [
                    { sWidth: "10%", bSearchable: false, bSortable: false },
                    { sWidth: "10", bSearchable: false, bSortable: false },
                    { sWidth: "10%", bSearchable: false, bSortable: false }

                ],
                "scrollCollapse": false,
                "info": true,
                "paging": true,
                "searching": true
            });


        }
        $(".loader").hide("slow");
    }

    $('#btnsubmit').click(function () {
        $('.loadingGIF').show();
        var errormessage = "";

       // if ($('#txtbarcode').val() == "") {
      //      errormessage += "Barcode Cannot be Left Empty.\n";
     //   }
        if (errormessage.length == 0) {
            //if ($('#txtmalkananumber').val() != "") {
            if (window.FormData !== undefined) {

    
                $(".loader").show("slow");
                $.ajax({
                    url: 'InsertPastingDetails',
                    dataType: "json",
                    type: "POST",
                    contentType: false, // Not to set any content header  
                    processData: false, // Not to process data  
                 //   data: formData,
                    success: function (data) {

                        var Res = data.split('|');
                 
                        var result = JSON.parse(Res[2]);
                        

                        if (Res[0].toUpperCase() == "TRUE") {
                            var values = result[0].PASTINGBARCODE;
                            var page = Res[1];
                            //var msg = Res[3];
                            //var barcodes = Res[1].split('quot;');
                            // var barcodes = Res[2];
                         
                            $("form").trigger("reset");
                            $("#printable").html(page);
                          
                            var COUNT = 1;
                            var ID = values;
                            QRCODEPRINT(COUNT, ID);
                            setTimeout(function () {
                                printableinner();
                                location.reload();
                            }, 20);
                            $("#actiontype").text("Save&Print")
                            $('.loadingGIF').hide();
                       

                            //bootbox.alert({
                            //    message: '<span class="text-success"><i class="ace-icon fa fa-check-circle fa-4x"></i><br>' + msg + '</span>',
                            //    size: 'small',
                            //    callback: function () {
                            //        location.reload();
                                    
                            //    }


                            //});
                            //sweetAlert("", msg.replace(/&quot;/g, "").replace(/<Br \/>/g, "\n"), "success");
                            //location.reload();

                        }
                        else {
                            $('.loadingGIF').hide();
                            //bootbox.alert({
                            //    message: '<span class="text-danger"><i class="ace-icon fa fa-exclamation-triangle fa-4x"></i><br>' + msg + '</span>',
                            //    size: 'small'
                            //});
                            //// $('.loadingGIF').hide();
                            ////sweetAlert("", msg.replace(/&quot;/g, "").replace(/<Br \/>/g, "\n"), "error");

                        }
                    }
                });
            }
        } else {
            bootbox.alert({
                message: '<span class="text-danger"><i class="ace-icon fa fa-exclamation-triangle fa-4x"></i><br>' + errormessage.replace(/<Br \/>/g, "\n") + '</span>',
                size: 'small',
                //callback: function () {
                //    location.reload();
                //}
            });
            // sweetAlert("", "Please Enter Malkananumber.", "error");
            // $('.loadingGIF').hide();
        }
    });
    function QRCODEPRINT(COUNT, ID) {
        var qrcode = new QRCode(document.getElementById("qrcode"), {
            width: 120,
            height: 120
        });
        function makeCode() {
            var elText = ID;
            qrcode.makeCode(elText);
        }
        makeCode();
    }

    function printableinner() {
        var disp_setting = "toolbar=no,location=no,";
        disp_setting += "directories=no,menubar=no,";
        disp_setting += "scrollbars=yes";
        var content_vlue = document.getElementById("printable").innerHTML;
        var docprint = window.open("", "", disp_setting);
        docprint.document.open();
        docprint.document.write('<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"');
        docprint.document.write('"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">');
        docprint.document.write('<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">');
        docprint.document.write('<head>');
        docprint.document.write('<style type="text/css">body{ border:0px solid #000;margin:0px;font-family:verdana,Arial;color:#000;font-family:Verdana, Geneva, sans-serif; font-size:8px;}a{color:#000;text-decoration:none;}*{font-size:8px;} small{font-size:30% !important;}table {border-collapse: collapse;}table, td, th {border: 1px solid black;padding:0.5rem 2px;}@page {size: 4in 2in;margin: 1mm;}div#printable {width: 4in;height: 2in;} .qr-panel img{width:50px;}</style> ');
        docprint.document.write('</head><body onLoad="self.print()">');
        docprint.document.write(content_vlue);
        docprint.document.close();
        docprint.focus();
    }
    function Clear() {
        location.reload();
    };
    $('#btnclear').click(Clear);
});